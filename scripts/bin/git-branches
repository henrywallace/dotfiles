#!/bin/bash

BLUE="$(tput setaf 4)"
RED="$(tput setaf 1)"
GREEN="$(tput setaf 2)"
# BOLD="$(tput bold)"
NC="$(tput sgr0)"

scale() {
  # n=$(bc -l <<< "scale=0; l($2)/1")
  # n=1
  # printf -- "$1%.0s" $(seq 1 $n)
  printf ""
}

diffstat() {
  branch="$1"
  diff="$(git diff --shortstat "$(git merge-base master "$branch")".."$branch")"
  chg="$(echo "$diff" | rg '(\d+) files? changed' -or '$1')"
  ins="$(echo "$diff" | rg '(\d+) insertions?' -or '$1')"
  del="$(echo "$diff" | rg '(\d+) deletions?' -or '$1')"
  sep=" "
  summary=""
  [[ -z "$chg" ]] || summary+="${BLUE}$(printf "%3s" "$(scale '*' $chg)${chg}")${NC}${sep}"
  [[ -z "$ins" ]] || summary+="${GREEN}$(printf "%5s" "$(scale '+' $ins)${ins}")${NC}${sep}"
  [[ -z "$del" ]] || summary+="${RED}$(printf "%5s" "$(scale '-' $del)${del}")${NC}"
  echo "$summary"
}

lastactive() {
  branch="$1"
  echo "$(git log --abbrev-commit -1 --date=relative "$branch"  | rg 'Date:\s+(.*)' -or '$1')"
}

i=0
for b in $(git branch --sort=-committerdate | sed 's/\* //'); do
  echo "${i} ${b}%%$(lastactive "$b")%%$(diffstat "$b")" &
  let i=$i+1
done | sort -nk1 | sed 's/^[0-9]\+ //' | column -t -s'%%'

