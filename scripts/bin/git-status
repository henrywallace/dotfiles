#!/bin/bash

set -e

git rev-parse --is-inside-work-tree > /dev/null

RED="$(tput setaf 1)"
BOLD="$(tput bold)"
NC="$(tput sgr0)"

branch=$(git branch | rg '\* ' | tr '*' ' ' | xargs)
stash="$(git stash list | wc -l | xargs)"
base="$(git merge-base master HEAD)"

diffstat() {
  diff="$(git diff --shortstat $base..HEAD)"
  changed="$(echo "$diff" | rg '(\d+) files? changed' -or '$1')"
  insertions="$(echo "$diff" | rg '(\d+) insertions?' -or '$1')"
  deletions="$(echo "$diff" | rg '(\d+) deletions?' -or '$1')"
  sep=" "
  summary=""
  [[ -z "$changed" ]] || summary+="*${changed}${sep}"
  [[ -z "$insertions" ]] || summary+="+${insertions}${sep}"
  [[ -z "$deletions" ]] || summary+="-${deletions}"
  echo "$summary"
}

if [[ "$stash" -gt 4 ]]; then
  stash="${BOLD}${RED}${stash}${NC} ðŸ¥º"
fi

echo -e "branch:\t${BOLD}${branch}${NC}"
if [[ "$stash" != 0 ]]; then
  echo -e "stash:\t${stash}"
fi
diff=$(diffstat)
if [[ ! -z $diff ]]; then
  echo -e "stat:\t$(diffstat)"
fi
len="$(git rev-list --count $base..HEAD)"
if [[ "$len" != 0 ]]; then
  echo -e "len:\t$len"
fi
echo
git status |
  rg -v 'On branch' |
  rg 'interactive rebase[^;]*' --passthru --color=always --colors=match:fg:red |
  rg '^   edit .*' --passthru --color=always --colors=match:style:nobold --colors=match:fg:red |
  rg 'new file:.*' --passthru --color=always --colors=match:fg:green --colors=match:style:nobold |
  rg '\tmodified:.*' --passthru --color=always --colors=match:fg:blue --colors=match:style:nobold |
  rg 'deleted:.*' --passthru --color=always --colors=match:fg:red --colors=match:style:nobold |
  rg '\tboth modified:.*' --passthru --color=always --colors=match:fg:yellow |
  rg 'nothing to commit.*' -r '$0 ðŸŒ±' --passthru --color=always --colors=match:fg:white --colors=match:style:nobold |
  rg -v '^  \(use' \
  || true

# git ls-files -u

